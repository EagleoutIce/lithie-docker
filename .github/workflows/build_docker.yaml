name: Build docker-images
'on':
  push: 
    branches:  
      - master
  schedule:
    # every two days build automatically
    - cron: '0 0 2 * *'
jobs:
  build:
    strategy:
      matrix:
        profile: [tx-small, tx-full, tx-default]
    name: Build texlive using the ${{ matrix.profile }}-Profile
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v2
        with:
          lfs: false
          submodules: true

      - name: Build the image
        run: |
          docker build -t lithie-${{ matrix.profile }} --build-arg target_profile=${{ matrix.profile }} .

      - name: Test that the image installed correctly
        run: |
          docker run --rm lithie-${{ matrix.profile }} pdflatex --version
          docker run --rm lithie-${{ matrix.profile }} latexmk --version

      - name: Deploy the image
        run: |
          TAG="ghcr.io/eagleoutice/lithie-${{ matrix.profile }}"
          VERSION="$(date "+%Y%m%d")"
          docker tag lithie-${{ matrix.profile }} ${TAG}:$VERSION
          docker tag lithie-${{ matrix.profile }} ${TAG}:latest
          docker images $TAG
          echo ${{ secrets.GHCR_IO }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
          docker push $TAG